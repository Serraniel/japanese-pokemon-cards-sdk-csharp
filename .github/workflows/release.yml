name: Release & Publish

on:
  push:
    branches: [main]
    paths:
      - "JpnCardsPokemon.Sdk/**"
      - "JpnCardsPokemon.Tests/**"
      - "*.sln"
      - ".github/workflows/release.yml"

permissions:
  contents: write
  packages: write

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    name: Release & Publish
    runs-on: ubuntu-latest

    steps:
      - name: Wait for merge queue settling
        run: sleep 300

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Determine version from tags
        id: version
        run: |
          # Get latest semver tag
          LATEST_TAG=$(git tag --list 'v*' --sort=-v:refname | head -n 1)

          if [ -z "$LATEST_TAG" ]; then
            NEW_VERSION="1.0.0"
          else
            # Strip 'v' prefix
            CURRENT="${LATEST_TAG#v}"
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

            # Check commit messages since last tag for version bump hints
            COMMITS=$(git log "${LATEST_TAG}..HEAD" --pretty=format:"%s" 2>/dev/null || echo "")

            if echo "$COMMITS" | grep -qiE "^(feat|feature)(\(.+\))?!:|BREAKING CHANGE"; then
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
            elif echo "$COMMITS" | grep -qiE "^(feat|feature)(\(.+\))?:"; then
              MINOR=$((MINOR + 1))
              PATCH=0
            else
              PATCH=$((PATCH + 1))
            fi

            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          fi

          echo "version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=v${NEW_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Determined version: ${NEW_VERSION}"

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore /p:Version=${{ steps.version.outputs.version }} /p:AssemblyVersion=${{ steps.version.outputs.version }} /p:FileVersion=${{ steps.version.outputs.version }}

      - name: Test
        run: dotnet test --configuration Release --no-build --verbosity normal

      - name: Pack
        run: dotnet pack JpnCardsPokemon.Sdk/JpnCardsPokemon.Sdk.csproj --configuration Release --no-build --output ./nupkg /p:Version=${{ steps.version.outputs.version }}

      - name: Publish binaries
        run: |
          dotnet publish JpnCardsPokemon.Sdk/JpnCardsPokemon.Sdk.csproj --configuration Release --no-build --output ./publish/net8.0 --framework net8.0
          dotnet publish JpnCardsPokemon.Sdk/JpnCardsPokemon.Sdk.csproj --configuration Release --no-build --output ./publish/net9.0 --framework net9.0
          dotnet publish JpnCardsPokemon.Sdk/JpnCardsPokemon.Sdk.csproj --configuration Release --no-build --output ./publish/net10.0 --framework net10.0
          dotnet publish JpnCardsPokemon.Sdk/JpnCardsPokemon.Sdk.csproj --configuration Release --no-build --output ./publish/net481 --framework net481
          dotnet publish JpnCardsPokemon.Sdk/JpnCardsPokemon.Sdk.csproj --configuration Release --no-build --output ./publish/netstandard2.0 --framework netstandard2.0
          dotnet publish JpnCardsPokemon.Sdk/JpnCardsPokemon.Sdk.csproj --configuration Release --no-build --output ./publish/netstandard2.1 --framework netstandard2.1

      - name: Generate SBOM
        run: |
          dotnet tool install --global CycloneDX
          dotnet CycloneDX JpnCardsPokemon.Sdk/JpnCardsPokemon.Sdk.csproj --json --output ./sbom

      - name: Create release archives
        run: |
          cd publish
          for dir in */; do
            framework="${dir%/}"
            zip -r "../JpnCardsPokemon.Sdk-${{ steps.version.outputs.version }}-${framework}.zip" "$framework"
          done
          cd ..
          cp sbom/bom.json "JpnCardsPokemon.Sdk-${{ steps.version.outputs.version }}-sbom.json"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.version }}
          generate_release_notes: true
          files: |
            ./nupkg/*
            ./JpnCardsPokemon.Sdk-${{ steps.version.outputs.version }}-*.zip
            ./JpnCardsPokemon.Sdk-${{ steps.version.outputs.version }}-sbom.json

      - name: Publish to GitHub Packages
        run: dotnet nuget push ./nupkg/*.nupkg --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" --api-key ${{ secrets.GITHUB_TOKEN }} --skip-duplicate

      - name: Publish to NuGet.org
        run: dotnet nuget push ./nupkg/*.nupkg --source "https://api.nuget.org/v3/index.json" --api-key ${{ secrets.NUGET_API_KEY }} --skip-duplicate
